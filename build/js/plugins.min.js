/* mdtable
 * version: 0.0.1
 * build: 2015-01-19 
 */
!function(a){"use strict";a.fn.mdtable=function(b){var c=this;b=a.extend(!0,{},a.fn.mdtable.defaults,b);var d={checkbox:{th:'<th width="38" class="check"><label class="checkbox-primary"></label></th>',td:'<td class="check"><label class="checkbox-primary"></label></td>'},error:'<tr><td class="mdtable-error" colspan="'+(b.columns.length+(b.multicheck?1:0))+'">'+b.message.error+"</td></tr>",empty:'<tr><td class="mdtable-empty" colspan="'+(b.columns.length+(b.multicheck?1:0))+'">'+b.message.empty+"</td></tr>",timeout:'<tr><td class="mdtable-timeout" colspan="'+(b.columns.length+(b.multicheck?1:0))+'">'+b.message.timeout+"</td></tr>",paging:'<nav class="pull-right"><ul class="pagination"><li class="first hidden"><a class="disabled" data-page="f">'+b.paging.firstText+'</a></li><li class="pre"><a class="disabled" data-page="p">'+b.paging.preText+'</a></li><li class="page"><a data-page="1">1</a></li><li class="next"><a class="disabled" data-page="n">'+b.paging.nextText+'</a></li><li class="last hidden"><a class="disabled" data-page="l">'+b.paging.lastText+"</a></li></ul></nav>"},e={count:0,data:[]},f=b.extra,g=-1,h=!1;this.wrap('<div class="'+b.wrapClass+' md-table-wrap"></div>').after(d.paging);var i=c.parent(),j=this.find("thead"),k=this.find("tbody");k.length||(j.after("<tbody></tbody>"),k=this.find("tbody"));for(var l=0;l<b.columns.length;l++){var m=b.columns[l],n=j.find("th,td").eq(l);m.sort&&m.sort.enable&&(!h&&m.sort["default"]?("asc"===m.sort["default"]?n.addClass("sorting_asc"):"desc"===m.sort["default"]&&n.addClass("sorting_desc"),g=l,h=!0):n.addClass("sorting"))}j.on("click","th:not(.check),tr:not(.check)",function(){var b=a(this),c=j.find("th:not(.check)").index(b);g=c,b.hasClass("sorting_desc")?(b.removeClass("sorting_desc").addClass("sorting_asc"),x(c,"asc")):(b.removeClass("sorting sorting_asc").addClass("sorting_desc"),x(c,"desc")),b.siblings().filter(".sorting,.sorting_asc,.sorting_desc").removeClass("sorting_asc sorting_desc").addClass("sorting")}),c.on("load.ok",function(){}).on("load.error",function(){});var o=1,p=0,q=0,r=b.paging.limit,s=1,t=1,u=c.next().find(".pagination").hide(),v={first:u.find("li.first"),first_a:u.find("li.first a"),pre:u.find("li.pre"),pre_a:u.find("li.pre a"),page:u.find("li.page"),next:u.find("li.next"),next_a:u.find("li.next a"),last:u.find("li.last"),last_a:u.find("li.last a")};if(c.on("page.change",function(){u.find("li.page a").eq(s-1).addClass("active"),1===s?v.pre_a.addClass("disabled"):v.pre_a.removeClass("disabled"),s===o?v.next_a.addClass("disabled"):v.next_a.removeClass("disabled"),c.find(".checkbox-primary").removeClass("checked")}),u.delegate("li a:not(.disabled,.active)","click",function(){var c=a(this),d=c.data("page");"f"===d?(q=0,t=0):"p"===d?(q-=r,t--):"n"===d?(q+=r,t++):"l"===d?(q=(o-1)*r,t=o):(d=parseInt(d),q=(d-1)*r,t=d),"remote"===b.mode?y(f):"local"===b.mode&&z()}),b.multicheck.enable){j.find("tr").prepend(d.checkbox.th);var w=j.find(".checkbox-primary");this.delegate(".checkbox-primary","click",function(){var b=a(this),d=k.find(".checkbox-primary");b.toggleClass("checked"),b.closest("thead").length>0?b.hasClass("checked")?d.addClass("checked"):d.removeClass("checked"):d.filter(".checked").length===d.length?w.addClass("checked"):w.removeClass("checked");var e=[],f=d.filter(".checked");f.each(function(a,b){e.push(d.index(b))}),c.trigger("select.change",[e])})}var x=function(c,f){k.empty();var h=e.data;if(h.length){if("local"!==b.mode&&h.length>r&&(h.length=r),c||(c=g),-1!==c){var i=b.columns[c];f=j.find("th:not(.check)").eq(c).hasClass("sorting_desc")?"desc":"asc",h.sort(function(a,b){var c=a[i.row],d=b[i.row];return i.rule&&"function"==typeof i.rule?i.rule(a,b)*("desc"===f?-1:1):c.toString().localeCompare(d.toString())*("desc"===f?-1:1)}),"local"===b.mode&&(h=h.slice((t-1)*r,t*r))}for(var l=0;l<h.length;l++){var m=a("<tr></tr>").addClass(l%2===0?"odd":"even");b.multicheck.enable&&m.append(d.checkbox.td);for(var n=0;n<b.columns.length;n++){var o=b.columns[n],p=h[l][o.row];o.renderer&&"function"==typeof o.renderer&&(p=o.renderer(p,h[l],h)),p instanceof a?(p.wrap("<td"+(o["class"]?' class="'+o["class"]+'"':"")+"></td>"),p=p.parent()):p=a("<td"+(o["class"]?' class="'+o["class"]+'"':"")+">"+p+"</td>"),m.append(p)}b.trRenderer&&b.trRenderer(m),m.data("row",h[l]),k.append(m)}}else k.empty().append(d.empty)},y=function(g){var h=a.extend({},g,{start:q,limit:r});f=g?g:f,a.load({url:g&&g.url?g.url:b.url,data:h,target:i,loading:b.loading,cache:b.cache?b.cache:!1,success:function(a){e=a,z()},error:function(a,b){e={},k.empty().append("timeout"===b?d.timeout:d.error),c.trigger("load.error")}})},z=function(){var a=null;if("local"===b.mode?a={count:e.data.length,data:e.data.slice((t-1)*r,t*r)}:"remote"===b.mode&&(a=e),a.data){if(a.count>r){u.show(),p=a.count,o=Math.ceil(p/r),s=t,u.find("li.page").remove();for(var f=0;o>f;f++){{var g=v.page.clone();g.find("a").attr("data-page",f+1).text(f+1)}v.next.before(g)}c.trigger("page.change")}else u.hide();x(null)}else k.empty().append(d.error);c.trigger("load.ok")};return"remote"===b.mode?y(b.extra):"local"===b.mode&&z(b.data),this.load=function(a){if("local"===b.mode)throw new Error("current is local mode.");q=0,y(a)},this.loadData=function(a){if("remote"===b.mode)throw new Error("current is remote mode.");q=0,e=a,z()},this.addData=function(a){if("remote"===b.mode)throw new Error("current is remote mode.");Array.prototype.push.apply(e.data,a),z()},this.removeDatas=function(){e.data=[],j.find(".check .checkbox-primary").removeClass("checked"),z()},this.removeSelectedDatas=function(){for(var b=k.find(".checkbox-primary"),c=b.filter(".checked"),d=c.length-1;d>=0;d--)e.data.splice(b.index(a(c[d])),1);0===e.data.length&&j.find(".check .checkbox-primary").removeClass("checked"),z()},this.getDatas=function(){return e.data},this.getSelection=function(){var b=k.find(".checkbox-primary"),c=b.filter(".checked"),d=[];return a.each(c,function(c,e){d.push(b.index(a(e)))}),d},c},a.fn.mdtable.defaults={wrapClass:"table-responsive",message:{empty:"暂无数据",error:"数据请求出错",timeout:"请求超时"},loading:"show",mode:"remote",cache:!1,multicheck:{enable:!1,callback:null},paging:{limit:10,firstText:"<<",lastText:">>",preText:"<",nextText:">"}},a.extend({load:function(b){b=a.extend({},a.loadDefaults,b);var c=a(b.target);"hide"!==b.loading&&(b.beforeSend=function(){c.loading("show")},b.complete=function(){c.loading("hide")}),a.ajax(b)},loadDefaults:{type:"get",loading:"show",timeout:1e4,target:window}}),a.fn.checkbox=function(){this.on("click",function(){a(this).toggleClass("checked")})},a.fn.loading=function(b){b=b||"show";var c=a(".md-mask").eq(parseInt(this.attr("data-loading")-1));if(0===c.length&&(c=a('<div class="md-mask"><div class="md-loading"><img src="images/loading.gif" alt="loading"/></div></div>'),a("body").append(c),this.attr("data-loading",a(".md-mask").length)),"show"===b){c.show();var d=c.find(".md-loading"),e=this.outerHeight(),f=this.outerWidth(),g=this.offset(),h=24,i=60;if(this[0]===window)c.css({top:0,left:0,width:f,height:e}).removeClass("hidden");else{var j=f>i?f:i,k=e>h?e:h;c.css({top:g.top,left:g.left,width:j,height:k}).removeClass("hidden")}return d.css("margin-top",(c.height()-d.height())/2),this}return"hide"===b?(c.hide(),this):void 0}}(jQuery);